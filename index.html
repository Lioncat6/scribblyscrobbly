<head>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.2.0/papaparse.min.js'></script>
	<script>
		function scribblyScrobbly(files) {

			var streamdata = []

			//songs played for shorter amount of time will be removed (seconds) 
			const requiredPlayDuration = 30

			//on last.fm you can scrobble 2800 tracks in a day, importing 2600 gives you room to scrobble 200 songs
			const importsPerDay = 2600

			document.getElementById("status").innerHTML += "</br>processing " + files.length + " file(s)"

			var reader = new FileReader()

			function readFile(index) {

				if (index >= files.length) {

					console.log("merged stream data", streamdata)

					adaptToScrubbler(streamdata) }
				
				else {

					let file = files[index]

					if (files[index].type == 'application/json') {

						reader.onload = function(e) {
							console.log(files[index].name, JSON.parse(reader.result))
							streamdata = streamdata.concat(JSON.parse(reader.result))
							document.getElementById("status").innerHTML += "loaded data from " + files[index].name + "</br>"
							readFile(index + 1) }

						reader.onerror = function() {
							document.getElementById("status").innerHTML += "<br/>error in trying to load a json file" }

						reader.readAsText(file) }

					else {

						config = {
							header: true,
							transformHeader: (header => header.replace(/\s/g, '')),
							complete: results => {
								streamdata = streamdata.concat(results.data)
								console.log("csv parsed stream data", streamdata)
								readFile(index + 1) } }

						Papa.parse(file, config) } } }

			function adaptToScrubbler(data) {

				document.getElementById("status").innerHTML += "</br>changing things so that <a href=\"https:github.com/coczero/Last.fm-Scrubbler-WPF\">Last.fm Scrubbler</a> can understand the streaming history";

				data = data.map(stream => ({
					artistName: stream.ArtistName? stream.ArtistName : stream.master_metadata_album_artist_name,
					albumName: stream.master_metadata_album_album_name,
					trackName: stream.ContentName? stream.ContentName : stream.master_metadata_track_name,
					datetime: stream.EventStartTimestamp? stream.EventStartTimestamp : stream.ts,
					playDuration: stream.PlayDurationMilliseconds? stream.PlayDurationMilliseconds : stream.ms_played 
				}))
				console.log("simplified stream data", data)

				data = data.filter(stream => stream.playDuration >= requiredPlayDuration * 1000)
				console.log("play duration filtered stream data", data)

				data = data.filter(stream => stream.trackName != undefined)
				console.log("removed streams without song names", data)

				data = data.sort((a,b) => Date.parse(a.datetime) - Date.parse(b.datetime))
				console.log("sorted stream data", data)

				const divide = function(array, size) {
					if (!array.length) { return [] }
					const head = array.slice(0, size)
					const tail = array.slice(size)
					return [head, ...divide(tail, size)] }

				data = divide(data, importsPerDay)
				console.log("fragmented stream data", data)

				writeFiles(data) }

			function writeFiles(data) {

				for (const day of data) {
					var file = new Blob( [JSON.stringify(day)] , { type: 'application/json' } )
					var element = document.createElement('a')
					element.setAttribute('href', window.URL.createObjectURL(file))
					element.setAttribute('download', day[0].datetime + '.json')
					element.classList.add('file-output')
					document.body.appendChild(element) }

				createDownloadButton() }

			function createDownloadButton() {

				element = document.createElement('button')
				element.innerHTML = 'download ' + document.getElementsByClassName('file-output').length + ' files'
				element.setAttribute('onclick', "for (link of document.getElementsByClassName('file-output')) { link.click() }")
				document.body.appendChild(element) }

			readFile(0) }
	</script>
</head>
<body>
	<p>
		Created by arsh#1221
		<a href="https:www.last.fm/user/TedBundyVEVO" style="color: red;">LastFM</a>
		<a href="https:open.spotify.com/user/arshbunny" style="color: chartreuse;">Spotify</a>
	</p>
	<p id="what-now">click choose files button and open csv and/or json files</p>
	<input type="file" id="file-input" accept=".json,.csv" onchange="scribblyScrobbly(this.files)" multiple/>
	<p id="status">current status:</p>
</body>
