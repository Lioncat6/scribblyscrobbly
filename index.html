<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset='utf-8'>
	<meta name='viewport' content='width=device-width, initial-scale=1'>
	<title>scribbly scrobbly</title>
	<style>
		body {
			font-family: sans-serif;
			height: 100vh;
			width: 100vw;
			margin: 0;
			text-rendering: optimizeLegibility;
			overflow: hidden }
		
		body, circle {
			display: flex;
			justify-content: center;
			align-items: center }

		circle {
			font-size: 48px;
			position: relative;
			transition: 0.2s ease-out;
			background: white;
			filter: drop-shadow(20px 20px 20px #b4f8) }
		
		circle:hover { transform: scale(1.05) }

		output {
			border: 0;
			background: 0 }
		
		circle, input, output {
			height: 100px;
			width: 100px;
			border-radius: 50% }

		output, input, output {
			cursor: pointer;
			position: absolute;
			font-size: 0;
			z-index: 1 }
		
		input::file-selector-button {display: none}

		caution {
			position: absolute;
			top: 16px }

		author {
			position: absolute;
			bottom: 16px }
	</style>
	<script>
		Object.defineProperty(File.prototype, 'extension', {
			get: function() { return this.name.substring(this.name.lastIndexOf('.') + 1) } } )
		
		Array.prototype.divideBy = function (divisor) {
			const copy = this.slice(0)
			this.length = 0
			while (copy.length)
				this.push(copy.splice(0, divisor))
			return this }
	</script>
	<script defer src='https://cdn.jsdelivr.net/npm/d3-dsv'></script>
	<script defer>
		const requiredPlayDuration = 30
		const importsPerDay = 2600

		let read = async (files) => {
			
			let streams = await Promise.all( [...files].map( file => parse(file) ) ).then(array => array.flat())
			
			streams = streams.filter( stream => stream.playDuration >= requiredPlayDuration * 1000 && stream.trackName != null && stream.trackName != '' )
							.sort( (a,b) => Date.parse(a.datetime) - Date.parse(b.datetime) )

			if (streams.length <= 0) document.querySelector('circle').innerText = 'üò∂'
			else {
				streams.divideBy(importsPerDay).forEach(day => {
					let file = new File( [JSON.stringify(day)], day[0].datetime + '.json', {type: 'application/json'} )
					let a = document.createElement('a')
					a.setAttribute('href', window.URL.createObjectURL(file))
					a.setAttribute('download', day[0].datetime + '.json')
					document.body.appendChild(a) })

				createDownloadButton(streams) } }
		
		let parse = async (file) => {
			
			const text = await file.text() 
			
			switch (file.extension) {
				case 'csv':
					return d3.csvParse(text, stream => ({
						artistName: stream['Artist Name'],
						trackName: stream['Content Name'],
						datetime: stream['Event Start Timestamp'],
						playDuration: +stream['Play Duration Milliseconds'] }))
				
				case 'json':
					return JSON.parse(text).map(stream => ({
						artistName: stream.master_metadata_album_artist_name,
						albumName: stream.master_metadata_album_album_name,
						trackName: stream.master_metadata_track_name,
						datetime: stream.ts,
						playDuration: stream.ms_played }))
				
				default:
					return [] } }
		
		let download = () => {				
			document.querySelectorAll('a[download]').forEach( x => x.click() )
			document.querySelector('circle').innerText = 'üëç' }
			
		let createDownloadButton = (streams) => {
			output = document.createElement('output')
			output.setAttribute('onclick', 'download()')
			document.querySelector('circle').innerText = 'üëá'
			document.querySelector('circle').appendChild(output) }
	</script>
</head>
<body>
	<circle>
		‚òùÔ∏è<input type='file' accept='.json,.csv' onchange='read(this.files); this.remove()' multiple/>
	</circle>
	<author>
		created by arsh#1221
		<a href='https://www.last.fm/user/TedBundyVEVO' style='color: #d50'>LastFM</a>
		<a href='https://open.spotify.com/user/arshbunny' style='color: #2d6'>Spotify</a>
	</author>
</body>
</html>
